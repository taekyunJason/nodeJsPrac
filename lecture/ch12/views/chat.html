{% extends 'layout.html' %}

{% block content %}
<h1>{{title}}</h1>
<a href="/" id="exit-btn">방 나가기</a>
<fieldset>
    <legend>채팅 내용</legend>
    <div id="chat-list">
        {% for chat in chats %}
        {% if chat.user === user %}
        <div class="mine" style="color: {{chat.user}}">
            <div>{{chat.user}}</div>
            {% if chat.gif %}}
            <img src="/gif/{{chat.gif}}">
            {% else %}
            <div>{{chat.chat}}</div>
            {% endif %}
        </div>
        {% elif chat.user === 'system' %}
        <div class="system">
            <div>{{chat.chat}}</div>
        </div>
        {% else %}
        <div class="other" style="color: {{chat.user}}">
            <div>{{chat.user}}</div>
            {% if chat.gif %}
            <img src="/gif/{{chat.gif}}">
            {% else %}
            <div>{{chat.chat}}</div>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
</fieldset>
<form action="/chat" id="chat-form" method="post" enctype="multipart/form-data">
    <label for="gif">GIF 올리기</label>
    <input type="file" id="gif" name="gif" accept="image/gif">
    <input type="text" id="chat" name="chat">
    <button type="submit">전송</button>
</form>
<script src="/socket.io/socket.io.js"></script>
<script>
    //네임스페이스로 로컬 호스트 뒤에 /chat이 붙어있음
    //채팅방에 대한 데이터를 실시간으로 전달받기 위해서 웹소켓 서버랑 연결하는 코드
    //네임스페이스로 제한을 해두면 네임스페이스(채팅방)에 대한 이벤트만 받을수 있음
    const socket = io.connect('http://localhost:8005/chat', {
        path: '/socket.io',
    });

    //사용자가 채팅방에 '참여'했을때 콜백함수 실행
    socket.on('join', function (data) {
        const div = document.createElement('div');
        div.classList.add('system');
        const chat = document.createElement('div');
        div.textContent = data.chat;
        div.appendChild(chat);
        document.querySelector('#chat-list').appendChild(div);
    });
    //사용자가 채팅방에 '퇴장'했을때 콜백함수 실행
    socket.on('exit', function (data) {
        const div = document.createElement('div');
        div.classList.add('system');
        const chat = document.createElement('div');
        div.textContent = data.chat;
        div.appendChild(chat);
        document.querySelector('#chat-list').appendChild(div);
    });
    //사용자가 채팅방에 '채팅 등록'했을때 콜백함수 실행
    //사용자가 채팅방에 'gif 등록'했을때 콜백함수 실행

</script>
{% endblock %}